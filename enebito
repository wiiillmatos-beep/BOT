import requests
from bs4 import BeautifulSoup
from aiogram import Bot, Dispatcher, executor, types
import asyncio
import datetime

# =====================================================
# CONFIGURAÃ‡Ã•ES DO USUÃRIO
# =====================================================

BOT_TOKEN = "8335817419:AAEw-tmkLQgi8n53B4hiWTgE4yKDNtYNVRM"
CHAT_ID = "@enebaofertas"
AFILIATE = "?af_id=WiillzeraTV&utm_medium=infl&utm_source=WiillzeraTV"

URL = "https://www.eneba.com/store/games/xbox?sort=lowest-price"

# HorÃ¡rios fixos
HORARIOS_POSTAGEM = ["11:00", "17:00", "20:00"]

# Quantidade de posts por horÃ¡rio
POSTS_POR_HORARIO = 4

# =====================================================

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher(bot)

posted_items = set()


def eh_hora_de_postar():
    agora = datetime.datetime.now().strftime("%H:%M")
    return agora in HORARIOS_POSTAGEM


# ðŸ”— Encurtador via TinyURL API
def encurtar_url(url):
    try:
        api_url = f"http://tinyurl.com/api-create.php?url={url}"
        short = requests.get(api_url).text
        return short
    except:
        return url


async def buscar_promocoes():
    global posted_items

    response = requests.get(URL, headers={"User-Agent": "Mozilla/5.0"})
    soup = BeautifulSoup(response.text, "html.parser")
    items = soup.select("div._gridItemContainer_15lym_33")

    contador = 0

    for item in items:
        if contador >= POSTS_POR_HORARIO:
            break

        try:
            title = item.select_one("span._title_1d8xv_9").text.strip()
            price = item.select_one("span._price_1d8xv_50").text.strip()
            link = "https://www.eneba.com" + item.select_one("a")["href"]

            # Adicionar link de afiliado
            if "?" in link:
                final_link = link + "&" + AFILIATE[1:]
            else:
                final_link = link + AFILIATE

            # Encurtar link
            short_link = encurtar_url(final_link)

            # Imagem do jogo
            img_tag = item.select_one("img")
            image_url = img_tag["src"] if img_tag else None

            # Evitar repetiÃ§Ã£o entre horÃ¡rios
            if title in posted_items:
                continue

            posted_items.add(title)
            contador += 1

            # TEMPLATE PERSONALIZADO
            texto = (
                f"ðŸŽ® **PromoÃ§Ã£o Xbox â€“ Eneba**\n\n"
                f"ðŸ•¹ *{title}*\n"
                f"ðŸ’¸ PreÃ§o agora: **{price}**\n\n"
                f"ðŸ”¥ Desconto especial Eneba\n"
                f"ðŸ‘‡ Clique no botÃ£o para comprar com desconto!"
            )

            # BotÃ£o "Comprar"
            keyboard = types.InlineKeyboardMarkup()
            btn = types.InlineKeyboardButton("ðŸ”¥ COMPRAR AGORA ðŸ”¥", url=short_link)
            keyboard.add(btn)

            # Enviar com foto se tiver
            if image_url:
                await bot.send_photo(
                    CHAT_ID,
                    photo=image_url,
                    caption=texto,
                    parse_mode="Markdown",
                    reply_markup=keyboard
                )
            else:
                await bot.send_message(
                    CHAT_ID,
                    texto,
                    parse_mode="Markdown",
                    reply_markup=keyboard
                )

            await asyncio.sleep(3)

        except Exception as e:
            print("Erro:", e)


async def scheduler():
    while True:
        if eh_hora_de_postar():
            print("ðŸ“¢ Postando promoÃ§Ãµes...")
            await buscar_promocoes()
            await asyncio.sleep(70)  # evitar duplicaÃ§Ãµes no mesmo minuto
        else:
            await asyncio.sleep(10)

if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.create_task(scheduler())
    executor.start_polling(dp, skip_updates=True)
